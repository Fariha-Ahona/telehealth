{% extends "base.html" %}

{% block title %}
Patient Dashboard
{% endblock %}

{% block content %}

<div class="bg-gradient-to-br from-[#dfe2ff] via-[#cbc1fa] to-[#a7c0f9] min-h-screen">
  <main class="max-w-6xl mx-auto px-6 pt-10 pb-20">

    <!-- Header -->
    <div class="mb-8">
      <h2 class="text-3xl font-extrabold text-violet-800">
        Welcome, {{ request.user.username }} ðŸ‘‹
      </h2>
      <p class="text-indigo-600">Your appointments & prescriptions</p>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">

      <!-- ================= APPOINTMENTS ================= -->
      <div class="glass p-8 shadow">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-indigo-800 text-lg">Appointments</h3>

          <a
            href="{% url 'doctors_list' %}"
            class="px-4 py-2 rounded-full bg-gradient-to-r from-indigo-500 to-violet-600 text-white font-semibold shadow hover:opacity-90"
          >
            Book Appointment
          </a>
        </div>

        {% if appointments %}
        <table class="w-full text-sm">
          <tr class="border-b font-semibold text-left text-indigo-700">
            <th class="py-2">Doctor</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
          </tr>

          {% for a in appointments %}
          <tr class="border-b">
            <td class="py-2">Dr. {{ a.slot.doctor.username }}</td>
            <td>{{ a.slot.date }}</td>
            <td>{{ a.slot.start_time }} - {{ a.slot.end_time }}</td>
            <td>
              {% if a.status == "PENDING" %}
                ðŸŸ¡ Pending Approval

              {% elif a.status == "APPROVED" %}
                ðŸŸ¢ Approved
                {% if a.consultation_status == "NOT_STARTED" %}
                  <div class="text-xs text-indigo-600">
                    Waiting for consultation
                  </div>
                {% elif a.consultation_status == "ONGOING" %}
                  <div class="text-xs text-blue-600">
                    Consultation ongoing
                  </div>
                {% elif a.consultation_status == "COMPLETED" %}
                  <div class="text-xs text-green-700">
                    Consultation completed
                  </div>
                {% endif %}

              {% elif a.status == "REJECTED" %}
                ðŸ”´ Rejected
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
          <p class="text-indigo-600">No appointments yet.</p>
        {% endif %}
      </div>

      <!-- ================= PRESCRIPTIONS ================= -->
      <div class="glass p-8 shadow">
        <h3 class="font-bold text-indigo-800 mb-4">Prescriptions</h3>

        {% with has_prescription=False %}
        {% for a in appointments %}
          {% if a.consultation_status == "COMPLETED" and a.prescription_pdf %}
            {% with has_prescription=True %}
            <div class="border p-4 rounded mb-3 bg-white/40">
              <p><strong>Doctor:</strong> Dr. {{ a.slot.doctor.username }}</p>
              <p class="text-sm text-gray-700">
                Date: {{ a.slot.date }}
              </p>

              <a
                href="{{ a.prescription_pdf.url }}"
                target="_blank"
                class="inline-block mt-2 text-indigo-600 font-semibold underline"
              >
                Download Prescription
              </a>
            </div>
            {% endwith %}
          {% endif %}
        {% endfor %}

        {% if not has_prescription %}
          <p class="text-indigo-600">No prescriptions yet.</p>
        {% endif %}
        {% endwith %}
      </div>

    </div>

    <!-- ================= PROFILE ================= -->
    <div class="glass p-8 shadow mt-8 max-w-md">
      <h3 class="font-bold text-indigo-800 mb-2">Profile</h3>
      <p class="text-indigo-700">
        <strong>Name:</strong> {{ request.user.username }} <br />
        <strong>Email:</strong> {{ request.user.email }}
      </p>
    </div>

  </main>
</div>

{% endblock %}
