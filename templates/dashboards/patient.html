{% extends "base.html" %}

{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-[#dfe2ff] via-[#cbc1fa] to-[#a7c0f9] min-h-screen py-10">
  <div class="max-w-6xl mx-auto px-6">

    <!-- Header -->
    <h2 class="text-3xl font-bold text-violet-800 mb-2">
      Welcome, {{ request.user.username }}
    </h2>
    

    <!-- Book button -->
    <div class="mb-10 justify-between flex items-center">
      <p class="text-violet-900 font-semibold text-xl ">Your appointments & prescriptions</p>
      <a href="{% url 'doctors_list' %}"
         class="px-5 py-2 bg-indigo-600 text-white rounded font-semibold">
        Book New Appointment
      </a>
    </div>

    <!-- Appointments -->
    <div class="bg-white rounded-lg p-6 shadow">
      <h3 class="text-xl font-bold text-indigo-800 mb-4">
        My Appointments
      </h3>

      {% if appointments %}
      <table class="w-full text-sm">
        <tr class="border-b font-semibold text-left">
          <th>Doctor</th>
          <th>Date</th>
          <th>Time</th>
          <th>Status</th>
          <th>Consultation</th>
          <th>Prescription</th>
        </tr>

        {% for a in appointments %}
        <tr class="border-t">

          <!-- Doctor -->
          <td class="py-2">
            Dr. {{ a.slot.doctor.username }}
          </td>

          <!-- Date -->
          <td class="py-2">
            {{ a.slot.date }}
          </td>

          <!-- Time -->
          <td class="py-2">
            {{ a.slot.start_time }} – {{ a.slot.end_time }}
          </td>

          <!-- STATUS -->
          <td class="font-semibold text-green-700 py-2">
            {% if a.status == "APPROVED" and a.consultation_status == "COMPLETED" %}
              COMPLETED
            {% elif a.status == "APPROVED" %}
              APPROVED
            {% elif a.status == "PENDING" %}
              PENDING
            {% else %}
              REJECTED
            {% endif %}
          </td>

          <!-- ✅ ZOOM JOIN (PATIENT) -->
          <td class="py-2">
            {% if a.consultation_status == "ONGOING" and a.zoom_join_url %}
              <a
                href="{{ a.zoom_join_url }}"
                target="_blank"
                class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-semibold"
              >
                Join Zoom
              </a>

            {% elif a.status == "APPROVED" and a.consultation_status == "NOT_STARTED" %}
              <span class="text-indigo-500 text-sm">
                Waiting for doctor
              </span>

            {% else %}
              <span class="text-gray-400 text-sm">—</span>
            {% endif %}
          </td>

          <!-- ✅ PRESCRIPTION -->
          <td class="max-w-sm py-2">
            {% if a.prescription %}
              <p class="text-sm text-indigo-700 truncate">
                {{ a.prescription|truncatechars:40 }}
              </p>

              <button
                onclick="openPrescription('{{ a.id }}')"
                class="mt-1 text-xs text-indigo-600 font-semibold hover:underline"
              >
                Read more
              </button>

              <div
                id="prescription-{{ a.id }}"
                class="hidden mt-2 p-3 bg-white rounded shadow text-sm text-gray-800"
              >
                {{ a.prescription|linebreaks }}
              </div>
            {% else %}
              <span class="text-gray-400 text-sm">—</span>
            {% endif %}
          </td>

        </tr>
        {% endfor %}
      </table>

      {% else %}
        <p class="text-indigo-600">No appointments yet.</p>
      {% endif %}
    </div>

  </div>
</div>

<!-- Toggle prescription -->
<script>
  function openPrescription(id) {
    const el = document.getElementById("prescription-" + id);
    el.classList.toggle("hidden");
  }
</script>

{% endblock %}
